<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>01 Setup a docker registry - Microservices with Kubernetes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "01 Setup a docker registry";
    var mkdocs_page_input_path = "03_Docker_registry/01_Setup_a_docker_registry.md";
    var mkdocs_page_url = "/03_Docker_registry/01_Setup_a_docker_registry/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Microservices with Kubernetes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../README/">README</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>01 Setup</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../01_Setup/01_Host_setup/">01 Host setup</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../01_Setup/02_Kubernetes_setup/">02 Kubernetes setup</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>02 First rest service</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../02_First_rest_service/01_JavaEE_service/">01 JavaEE service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../02_First_rest_service/02_Dockerization/">02 Dockerization</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../02_First_rest_service/03_Deploy_in_Kubernetes/">03 Deploy in Kubernetes</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>03 Docker registry</span></li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">01 Setup a docker registry</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#setup-a-docker-registry">Setup a docker registry</a></li>
                
                    <li><a class="toctree-l4" href="#create-folders-for-the-persistence">Create folders for the persistence</a></li>
                
                    <li><a class="toctree-l4" href="#create-ssl-certificates">Create SSL certificates</a></li>
                
                    <li><a class="toctree-l4" href="#kubernetes-deployment">Kubernetes deployment</a></li>
                
                    <li><a class="toctree-l4" href="#kubernetes-service">Kubernetes service</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>04 Jenkins</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../04_Jenkins/01_Setup_Jenkins_in_Kubernetes/">01 Setup Jenkins in Kubernetes</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>05 Build and push ci step</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../05_Build_and_push_ci_step/01_Build_and_push_CI_step/">01 Build and push CI step</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>06 Systemtest ci step</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../06_Systemtest_ci_step/01_Setup_test_env/">01 Setup test env</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../06_Systemtest_ci_step/02_Systemtest/">02 Systemtest</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../06_Systemtest_ci_step/03_Start_pipeline_on_every_push/">03 Start pipeline on every push</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>07 UI test</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../07_UI_test/01_UI_Test/">01 UI Test</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>08 Lasttest</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../08_Lasttest/01_Last_test/">01 Last test</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>09 Manual test</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../09_Manual_test/01_Create_manual_test/">01 Create manual test</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>10 Canary release</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../10_Canary_release/01_Create_a_canary_release/">01 Create a canary release</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>11 Full production release</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../11_Full_production_release/01_Go_full_production/">01 Go full production</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>12 Own Gogs</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../12_Own_Gogs/01_Use_your_own_Git_repository/">01 Use your own Git repository</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>13 Monitoring</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../13_Monitoring/01_Dashboard/">01 Dashboard</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../13_Monitoring/02_Prometheus/">02 Prometheus</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../13_Monitoring/03_Weave_scope/">03 Weave scope</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>14 Documentation of rest service</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../14_Documentation_of_rest_service/01_Documentation/">01 Documentation</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>15 Angular2 frontend</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../15_Angular2_frontend/01_Initial_setup/">01 Initial setup</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../15_Angular2_frontend/02_Test_and_prod_stage/">02 Test and prod stage</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../15_Angular2_frontend/03_First_view/">03 First view</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>16 SSO with Keycloak</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../16_SSO_with_Keycloak/01_Setup_Keycloak/">01 Setup Keycloak</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../16_SSO_with_Keycloak/02_Initial_setup_of_Keycloak/">02 Initial setup of Keycloak</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../16_SSO_with_Keycloak/03_Secure_REST_service/">03 Secure REST service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../16_SSO_with_Keycloak/04_Secure_frontend_service/">04 Secure frontend service</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>17 Event Sourcing with Cassandra</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../17_Event_Sourcing_with_Cassandra/01_Setup_Cassandra/">01 Setup Cassandra</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../17_Event_Sourcing_with_Cassandra/02_REST_service_with_event_sourcing/">02 REST service with event sourcing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../17_Event_Sourcing_with_Cassandra/03_Changes_to_the_frontend/">03 Changes to the frontend</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>18 Connect keycloak user with application user</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../18_Connect_keycloak_user_with_application_user/01_Setup_keycloak_with_a_provider/">01 Setup keycloak with a provider</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../18_Connect_keycloak_user_with_application_user/02_Changes_to_the_REST_service/">02 Changes to the REST service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../18_Connect_keycloak_user_with_application_user/03_Changes_in_the_environment/">03 Changes in the environment</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>19 CQRS with Kafka</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../19_CQRS_with_Kafka/01_Setup_Kafka/">01 Setup Kafka</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../19_CQRS_with_Kafka/02_Command_service/">02 Command service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../19_CQRS_with_Kafka/03_Query_service/">03 Query service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../19_CQRS_with_Kafka/04_Frontend_service/">04 Frontend service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../19_CQRS_with_Kafka/05_Other_updates/">05 Other updates</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>20 Fileuploader</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../20_Fileuploader/01_Create_fileuploader_service/">01 Create fileuploader service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../20_Fileuploader/02_REST_service_adaptions/">02 REST service adaptions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../20_Fileuploader/03_Query_service_adaptions/">03 Query service adaptions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../20_Fileuploader/04_Frontend_adaptions/">04 Frontend adaptions</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Microservices with Kubernetes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>03 Docker registry &raquo;</li>
        
      
    
    <li>01 Setup a docker registry</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/robertBrem/Microservices_with_Kubernetes/edit/master/docs/03_Docker_registry/01_Setup_a_docker_registry.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="setup-a-docker-registry">Setup a docker registry</h1>
<h2 id="create-folders-for-the-persistence">Create folders for the persistence</h2>
<p>The Docker registry has persistent data therefore we've to mount this data somewhere.
The easiest way to do that is over a node selector. A more advanced solution would be
to use GlusterFS, Flocker, NFS or something similar.</p>
<p>If we use node selectors for our persistence then we've to log in to the server
that ip is used in the DNS registry. In my case that's the master.</p>
<pre><code>ssh root@5.189.173.45
</code></pre>

<p>On the server we've to create the folder structure that gets mounted to the host.
In our case we have three folders one for the Docker images, one for our ssl certificates
and the last for the authorization information.  </p>
<pre><code>mkdir -p registry/{images,certs,auth}
sudo docker run --entrypoint htpasswd registry:2 -Bbn rob 1234 &gt; registry/auth/htpasswd
</code></pre>

<p>The last command creates a user with a password for the Docker registry.</p>
<h2 id="create-ssl-certificates">Create SSL certificates</h2>
<p>We are going to create SSL certificates with LetsEncrypt. Therefore we have to install
LetsEncrypt on the server:</p>
<pre><code>sudo yum update -y
sudo yum install epel-release -y
sudo yum install letsencrypt -y
</code></pre>

<p>Now we can create the certificates:</p>
<pre><code>sudo letsencrypt certonly -d disruptor.ninja
</code></pre>

<p>The certificates are created under the following folder:</p>
<pre><code>/etc/letsencrypt/live/disruptor.ninja
</code></pre>

<p>The certificates have to be visible for the Docker registry therefore we copy them to
the <code>certs</code> folder we have created:</p>
<pre><code>sudo cp /etc/letsencrypt/live/disruptor.ninja/fullchain.pem registry/certs/
sudo cp /etc/letsencrypt/live/disruptor.ninja/privkey.pem registry/certs/
</code></pre>

<h2 id="kubernetes-deployment">Kubernetes deployment</h2>
<p>To tell Kubernetes to schedule the Docker registry pod on the master node we've to 
label the node:</p>
<pre><code>kc label nodes vmi74448.contabo.host name=vmi74448
</code></pre>

<p>Next we create a <code>deployment.yml</code> file <a href="https://gist.github.com/robertBrem/3df0c7d672a9942bbbddb45d0b6f297a">like this one</a>.</p>
<pre><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: registry
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: registry
    spec:
      containers:
      - resources:
        name: registry
        image: registry:2
        ports:
        - name: registry-port
          containerPort: 5000
        volumeMounts:
        - mountPath: /var/lib/registry
          name: images
        - mountPath: /certs
          name: certs
        - mountPath: /auth
          name: auth
        env:
        - name: REGISTRY_AUTH
          value: &quot;htpasswd&quot;
        - name: REGISTRY_AUTH_HTPASSWD_REALM
          value: &quot;Registry Realm&quot;
        - name: REGISTRY_AUTH_HTPASSWD_PATH
          value: /auth/htpasswd
        - name: REGISTRY_HTTP_TLS_CERTIFICATE
          value: /certs/fullchain.pem
        - name: REGISTRY_HTTP_TLS_KEY
          value: /certs/privkey.pem
      volumes:
      - name: images
        hostPath:
          path: /root/registry/images
      - name: certs
        hostPath:
          path: /root/registry/certs
      - name: auth
        hostPath:
          path: /root/registry/auth
      nodeSelector:
        name: vmi74448
</code></pre>

<p>This file has to be deployed:</p>
<pre><code>kc create -f deployment.yml
</code></pre>

<p>To test if the deployment is working you can display all pods:</p>
<pre><code>kc get po
</code></pre>

<pre><code>NAME                      READY     STATUS    RESTARTS   AGE
registry-95525520-9rdvc   1/1       Running   0          1m
</code></pre>

<h2 id="kubernetes-service">Kubernetes service</h2>
<p>To make the registry visible outside the cluster we have to create a Kubernetes service.
The <code>service.yml</code> file can be created similar to <a href="https://gist.github.com/robertBrem/68706f161388b7307bb0">this file</a>.</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  name: registry
  labels:
    name: registry
spec:
  ports:
  - port: 5001
    targetPort: 5000
    nodePort: 30500
  selector:
    name: registry
  type: NodePort
</code></pre>

<p>To test the registry we can call the following url:</p>
<pre><code>https://disruptor.ninja:30500/v2/_catalog
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../04_Jenkins/01_Setup_Jenkins_in_Kubernetes/" class="btn btn-neutral float-right" title="01 Setup Jenkins in Kubernetes">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../02_First_rest_service/03_Deploy_in_Kubernetes/" class="btn btn-neutral" title="03 Deploy in Kubernetes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/robertBrem/Microservices_with_Kubernetes" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../02_First_rest_service/03_Deploy_in_Kubernetes/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../04_Jenkins/01_Setup_Jenkins_in_Kubernetes/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
